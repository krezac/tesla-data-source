from lap_forecast import do_forecast
from ds_types import Configuration, LapStatus, ForecastResult, CarStatus
import pendulum


def test_forecast():
    now = pendulum.datetime(2020, 12, 26, 19, 22, 11)

    config = Configuration(
        enabled=True,
        defaultPageTitle='Teslicka Record-24',
        defaultPageTemplate='dashboard.html',
        debugSql=False,
        carId=2,
        startLatitude=49.532655,
        startLongitude=12.135862,
        startRadius=100.0,
        startTime=pendulum.DateTime(2020, 12, 26, 17, 9),
        hours=24,
        mergeFromLap=1,
        lapsMerged=1,
        consumptionRated=14.7,
        statusRefreshSeconds=3,
        lapsRefreshSeconds=10,
        fioRefreshSeconds=900,
        defaultMapZoom=16,
        previousLaps=10,
        minTimeLap=10,
        forecastUseLaps=3,
        forecastExcludeLaps=1,
        mapLabels=[],
        textLabels=[],
        lapLabelsTotal=[],

        lapLabelsRecent=[],
        lapLabelsPrevious=[],
        chargingLabels=[],
        forecastLabels=[]
    )


    car_status = CarStatus(
        id=40220,
        date=pendulum.DateTime(2020, 12, 27, 20, 9, 59, 747000),
        latitude=50.263358, longitude=14.498249,
        speed=0.0,
        power=1.0,
        odometer=16625.489126,
        ideal_battery_range_km=366.69,
        battery_level=78,
        outside_temp=2.0,
        elevation=173.0,
        inside_temp=3.0,
        est_battery_range_km=340.02,
        rated_battery_range_km=366.69,
        usable_battery_level=76,
        car_name='Tesliƒçka TM3P',
        driver_name='Ondra',
        start_odometer=16143.007795,
        distance=482.48133100000086,
        lap=None, lap_distance=None,
        start_time=pendulum.DateTime(2020, 12, 26, 17, 9, 0),
        end_time=pendulum.DateTime(2020, 12, 27, 17, 9, 0),
        time_since_start=pendulum.Period(pendulum.parse('2020-12-26T17:09:00+00:00'),
                                         now),
        time_to_end=pendulum.Period(now, pendulum.parse('2020-12-27T17:09:00+00:00')),
    )

    laps = [
        LapStatus(id='1', startTime=pendulum.DateTime(2020, 12, 26, 17, 9, 22, 453000),
                  endTime=pendulum.DateTime(2020, 12, 26, 17, 38, 4, 840000),
                  startTimePit=pendulum.DateTime(2020, 12, 26, 17, 9, 3, 909000),
                  endTimePit=pendulum.DateTime(2020, 12, 26, 17, 9, 22, 453000),
                  startOdo=16143.185766, endOdo=16221.207771, insideTemp=19.5, outsideTemp=1.0, startSOC=46.0,
                  endSOC=7.0, startRangeIdeal=218.76, endRangeIdeal=28.89, startRangeEst=158.47, endRangeEst=13.63,
                  startRangeRated=218.76, endRangeRated=28.89, consumptionRated=14.7, finished=True, driver_name=None,
                  duration=pendulum.Period(pendulum.parse("2020-12-26T17:09:22.453000+00:00"),
                                           pendulum.parse("2020-12-26T17:38:04.840000+00:00")),
                  pitDuration=pendulum.Period(pendulum.parse("2020-12-26T17:09:03.909000+00:00"),
                                              pendulum.parse("2020-12-26T17:09:22.453000+00:00")),
                  distance=78.0220049999989, avgSpeed=163.11220557491058, startEnergy=32.15772, endEnergy=4.24683,
                  energy=27.91089, chargeStartTime=None, chargeEndTime=None, chargeEnergyAdded=None,
                  chargeStartSoc=None, chargeEndSoc=None, chargeStartRangeRated=None, chargeEndRangeRated=None,
                  chargeSocAdded=None, chargeRangeRatedAdded=None,
                  chargeDuration=pendulum.Period(pendulum.parse("2021-01-01T13:18:38.164556+01:00"),
                                                 pendulum.parse("2021-01-01T13:18:38.164580+01:00"))),
        LapStatus(id='2',
                  startTime=pendulum.DateTime(2020, 12, 26, 17, 54, 17, 486000),
                  endTime=pendulum.DateTime(2020, 12, 26, 18, 21, 0, 416000),
                  startTimePit=pendulum.DateTime(2020, 12, 26, 17, 38, 4, 840000),
                  endTimePit=pendulum.DateTime(2020, 12, 26, 17, 54, 17, 486000),
                  startOdo=16222.944771, endOdo=16299.606774, insideTemp=19.5, outsideTemp=1.5, startSOC=49.0,
                  endSOC=7.0, startRangeIdeal=236.65, endRangeIdeal=33.72, startRangeEst=109.23, endRangeEst=14.15,
                  startRangeRated=236.65, endRangeRated=33.72, consumptionRated=14.7, finished=True,
                  driver_name='Ondra', duration=pendulum.Period(pendulum.parse("2020-12-26T17:54:17.486000+00:00"),
                                                                pendulum.parse("2020-12-26T18:21:00.416000+00:00")),
                  pitDuration=pendulum.Period(pendulum.parse("2020-12-26T17:38:04.840000+00:00"),
                                              pendulum.parse("2020-12-26T17:54:17.486000+00:00")),
                  distance=76.66200299999946, avgSpeed=172.2741640449426, startEnergy=34.787549999999996,
                  endEnergy=4.95684, energy=29.830709999999996,
                  chargeStartTime=pendulum.DateTime(2020, 12, 26, 17, 39, 4, 98000),
                  chargeEndTime=pendulum.DateTime(2020, 12, 26, 17, 52, 49, 823000),
                  chargeEnergyAdded=32.36, chargeStartSoc=6, chargeEndSoc=51, chargeStartRangeRated=30.27,
                  chargeEndRangeRated=243.53, chargeSocAdded=45, chargeRangeRatedAdded=213.26,
                  chargeDuration=pendulum.Period(pendulum.parse("2020-12-26T17:39:04.098000+00:00"),
                                                 pendulum.parse("2020-12-26T17:52:49.823000+00:00"))),
        LapStatus(id='3', startTime=pendulum.DateTime(2020, 12, 26, 18, 30, 36, 895000),
                  endTime=pendulum.DateTime(2020, 12, 26, 18, 50, 40, 430000),
                  startTimePit=pendulum.DateTime(2020, 12, 26, 18, 21, 0, 416000),
                  endTimePit=pendulum.DateTime(2020, 12, 26, 18, 30, 36, 895000), startOdo=16300.306774,
                  endOdo=16355.028777, insideTemp=19.5, outsideTemp=0.5, startSOC=36.0, endSOC=5.0,
                  startRangeIdeal=170.61, endRangeIdeal=24.77, startRangeEst=70.84, endRangeEst=10.41,
                  startRangeRated=170.61, endRangeRated=24.77, consumptionRated=14.7, finished=True,
                  driver_name='Norton',
                  duration=pendulum.Period(pendulum.parse("2020-12-26T18:30:36.895000+00:00"),
                                           pendulum.parse("2020-12-26T18:50:40.430000+00:00")),
                  pitDuration=pendulum.Period(pendulum.parse("2020-12-26T18:21:00.416000+00:00"),
                                              pendulum.parse("2020-12-26T18:30:36.895000+00:00")),
                  distance=54.72200299999895, avgSpeed=163.75661745635594, startEnergy=25.07967,
                  endEnergy=3.64119, energy=21.43848,
                  chargeStartTime=pendulum.DateTime(2020, 12, 26, 18, 21, 38, 833000),
                  chargeEndTime=pendulum.DateTime(2020, 12, 26, 18, 29, 19, 123000), chargeEnergyAdded=20.63,
                  chargeStartSoc=7, chargeEndSoc=36, chargeStartRangeRated=35.08, chargeEndRangeRated=170.61,
                  chargeSocAdded=29, chargeRangeRatedAdded=135.53000000000003,
                  chargeDuration=pendulum.Period(pendulum.parse("2020-12-26T18:21:38.833000+00:00"),
                                                 pendulum.parse("2020-12-26T18:29:19.123000+00:00"))),
        LapStatus(id='4', startTime=pendulum.DateTime(2020, 12, 26, 19, 1, 51, 184000),
                  endTime=pendulum.DateTime(2020, 12, 26, 19, 14, 17, 193000),
                  startTimePit=pendulum.DateTime(2020, 12, 26, 18, 50, 40, 430000),
                  endTimePit=pendulum.DateTime(2020, 12, 26, 19, 1, 51, 184000),
                  startOdo=16355.606777, endOdo=16393.609778, insideTemp=19.5, outsideTemp=0.5,
                  startSOC=34.0, endSOC=8.0, startRangeIdeal=164.41, endRangeIdeal=35.78,
                  startRangeEst=70.94, endRangeEst=12.41, startRangeRated=164.41,
                  endRangeRated=35.78, consumptionRated=14.7, finished=True, driver_name='Norton2',
                  duration=pendulum.Period(pendulum.parse("2020-12-26T19:01:51.184000+00:00"),
                                           pendulum.parse("2020-12-26T19:14:17.193000+00:00")),
                  pitDuration=pendulum.Period(pendulum.parse("2020-12-26T18:50:40.430000+00:00"),
                                              pendulum.parse("2020-12-26T19:01:51.184000+00:00")),
                  distance=38.00300099999731, avgSpeed=183.3924981233114, startEnergy=24.16827,
                  endEnergy=5.25966, energy=18.90861,
                  chargeStartTime=pendulum.DateTime(2020, 12, 26, 18, 53, 17, 640000),
                  chargeEndTime=pendulum.DateTime(2020, 12, 26, 19, 0, 57, 448000),
                  chargeEnergyAdded=21.16, chargeStartSoc=5, chargeEndSoc=34,
                  chargeStartRangeRated=24.77, chargeEndRangeRated=163.73, chargeSocAdded=29,
                  chargeRangeRatedAdded=138.95999999999998,
                  chargeDuration=pendulum.Period(pendulum.parse("2020-12-26T18:53:17.640000+00:00"),
                                                 pendulum.parse(
                                                     "2020-12-26T19:00:57.448000+00:00"))),
        LapStatus(id='5', startTime=pendulum.DateTime(2020, 12, 26, 19, 41, 38, 243000),
                  endTime=pendulum.DateTime(2020, 12, 29, 18, 33, 17, 757000),
                  startTimePit=pendulum.DateTime(2020, 12, 26, 19, 14, 17, 193000),
                  endTimePit=pendulum.DateTime(2020, 12, 26, 19, 41, 38, 243000),
                  startOdo=16394.160779, endOdo=16625.44779, insideTemp=4.4,
                  outsideTemp=2.0, startSOC=50.0, endSOC=76.0, startRangeIdeal=241.47,
                  endRangeIdeal=366.69, startRangeEst=86.97, endRangeEst=340.02,
                  startRangeRated=241.47, endRangeRated=366.69, consumptionRated=14.7,
                  finished=False, driver_name='Norton2', duration=pendulum.Period(
                pendulum.parse("2020-12-29T18:33:17.757000+00:00"),
                pendulum.parse("2020-12-26T19:41:38.243000+00:00")),
                  pitDuration=pendulum.Period(
                      pendulum.parse("2020-12-26T19:14:17.193000+00:00"),
                      pendulum.parse("2020-12-26T19:41:38.243000+00:00")),
                  distance=231.2870109999967, avgSpeed=10.117173229322205,
                  startEnergy=35.496089999999995, endEnergy=53.90343,
                  energy=-18.407340000000005,
                  chargeStartTime=pendulum.DateTime(2020, 12, 26, 19, 15, 12, 252000),
                  chargeEndTime=pendulum.DateTime(2020, 12, 26, 19, 27, 33, 11000),
                  chargeEnergyAdded=31.21, chargeStartSoc=7, chargeEndSoc=50,
                  chargeStartRangeRated=35.78, chargeEndRangeRated=241.47,
                  chargeSocAdded=43, chargeRangeRatedAdded=205.69,
                  chargeDuration=pendulum.Period(
                      pendulum.parse("2020-12-26T19:15:12.252000+00:00"),
                      pendulum.parse("2020-12-26T19:27:33.011000+00:00")))
    ]

    do_forecast(config, laps, car_status, now )
